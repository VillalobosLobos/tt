<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/styles/crudEjercicios.css" type="text/css">
  <link rel="icon" href="/static/img/iconos/8.png" type="image/png">

  <title>CRUD Ejercicios</title>
  <!-- Enlaza tu CSS de crudEjercicios -->
  <link rel="stylesheet" href="../../static/styles/crudEjercicios.css" type="text/css" />
</head>
<body>

  <!-- Botón de regreso -->
  <button class="back-btn" onclick="window.history.back()">
    &#10094; Regresar
  </button>

  <!-- Contenedor principal -->
  <div class="cuerpo">
    
    <label for="titulo">Título de la actividad:</label>
    <input type="text" name="titulo" id="titulo" value="{{ ejercicio[1] }}">

    <br><br>
    <!-- Selector de tipo -->
    <label for="opciones">Elige una opción:</label>
    <select id="opciones" class="form-select" onchange="mostrarFormulario()">
      <option value="">Opciones</option>
      <option value="letra">Letras</option>
      <option value="numero">Dígitos</option>
    </select>

    <!-- Formulario de letras -->
    <form id="formLetra" class="formulario" onsubmit="agregarLetra(event)" style="display: none;">
      <label for="selectLetra">Escoja una letra:</label>
      <select id="selectLetra" class="form-select">
        <option value="">Opciones</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="E">E</option>
        <option value="F">F</option>
        <option value="G">G</option>
        <option value="H">H</option>
        <option value="I">I</option>
        <option value="J">J</option>
        <option value="K">K</option>
        <option value="L">L</option>
        <option value="M">M</option>
        <option value="N">N</option>
        <option value="O">O</option>
        <option value="P">P</option>
        <option value="Q">Q</option>
        <option value="R">R</option>
        <option value="S">S</option>
        <option value="T">T</option>
        <option value="U">U</option>
        <option value="V">V</option>
        <option value="W">W</option>
        <option value="X">X</option>
        <option value="Y">Y</option>
        <option value="Z">Z</option>
      </select>
      <button type="submit" class="btn-accion">Agregar</button>
    </form>

    <!-- Formulario de números -->
    <form id="formNumero" class="formulario" onsubmit="agregarNumero(event)" style="display: none;">
      <label for="selectNumero">Escoja un dígito:</label>
      <select id="selectNumero" class="form-select">
        <option value="">Opciones</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
      <button type="submit" class="btn-accion">Agregar</button>
    </form>

    <!-- Tabla de resultados -->
    <table id="tablaValores" class="tabla-resultados">
      <thead>
        <tr>
          <th>Letra o Digito seleccionado</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla">
        <!-- Aquí se agregan las filas -->
      </tbody>
    </table>
    <!-- Botón actualizar -->
    <button onclick="actualizarEjercicio('{{ ejercicio[0] }}')" style="margin-top: 20px;" class="subireje">
      Actualizar ejercicio
    </button>

  </div> <!-- /.cuerpo -->
  
  <script>
    let draggedRow = null;
    const cuerpoTabla = document.getElementById('cuerpoTabla');
    
    // Al iniciar, marcar todas las filas existentes
    document.querySelectorAll('#cuerpoTabla tr').forEach(fila => {
        prepararFilaParaDrag(fila);
    });
    
    function prepararFilaParaDrag(fila) {
      fila.setAttribute('draggable', 'true'); // ¡Importante!
    
      fila.addEventListener('dragstart', function(event) {
        draggedRow = fila;
        fila.classList.add('dragging');
      });
    
      fila.addEventListener('dragend', function(event) {
        fila.classList.remove('dragging');
        draggedRow = null;
      });
    }
    
    // Evento sobre el cuerpo de la tabla para ordenar
    cuerpoTabla.addEventListener('dragover', function(event) {
      event.preventDefault();
      const afterElement = getDragAfterElement(cuerpoTabla, event.clientY);
      if (afterElement == null) {
        cuerpoTabla.appendChild(draggedRow);
      } else {
        cuerpoTabla.insertBefore(draggedRow, afterElement);
      }
    });
    
    // Función para encontrar el lugar correcto donde insertar
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
    
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // Esta es tu función para agregar dinámicamente filas
    function agregarFilaATabla(valor) {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td style="text-align:center;">${valor}</td>
        <td style="text-align:center;">
          <button onclick="eliminarFila(this)" style="background-color: #f66; border: none; padding: 5px 10px; border-radius: 5px;">Eliminar</button>
        </td>
      `;
      prepararFilaParaDrag(fila); // <<< IMPORTANTE: marcar cada fila nueva
      cuerpoTabla.appendChild(fila);
    }
    
    // Para eliminar filas
    function eliminarFila(boton) {
      const fila = boton.closest('tr');
      fila.remove();
    }
    
    // Aquí llenas la tabla inicialmente con los datos que te mandan
    let respuesta = {{ respuesta | tojson }};
    respuesta.forEach(function(valor) {
        agregarFilaATabla(valor);
    });
    </script>
    

<style>
  #cuerpoTabla tr {
    cursor: move; /* Mostrar la manita para saber que se puede arrastrar */
  }
  </style>  

    <!-- Cargar JS externo -->
    <script src="{{ url_for('static', filename='js/mostrarCrudPreguntas.js') }}"></script>
    <script>
      let respuesta = {{ respuesta | tojson }};
  
      respuesta.forEach(function(valor) {
          agregarFilaATabla(valor);
      });
    </script>
  </body>
  </html>

